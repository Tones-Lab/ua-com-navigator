#!/usr/bin/env bash
set -euo pipefail

msg_file="${1:-}"
if [[ -z "${msg_file}" || ! -f "${msg_file}" ]]; then
  echo "commit-msg hook: missing commit message file" >&2
  exit 1
fi

title="$(head -n 1 "${msg_file}")"

if [[ ! "${title}" =~ ^(feat|fix|refactor|docs|chore|test|perf|build|ci|revert)\([a-z0-9._/-]+\):\ .+ ]]; then
  cat >&2 <<'EOF'
Invalid commit title.
Expected: <type>(<scope>): <summary>
Allowed types: feat|fix|refactor|docs|chore|test|perf|build|ci|revert
EOF
  exit 1
fi

if (( ${#title} > 72 )); then
  echo "Commit title exceeds 72 characters (${#title})." >&2
  exit 1
fi

has_header() {
  local header="$1"
  grep -qx "${header}" "${msg_file}"
}

section_has_bullet() {
  local section="$1"
  local next_section="$2"

  awk -v section="${section}" -v next_section="${next_section}" '
    $0 == section { in_section = 1; next }
    in_section && next_section != "" && $0 == next_section { exit(found ? 0 : 1) }
    in_section && /^- / { found = 1 }
    END {
      if (!in_section) {
        exit 2
      }
      if (found) {
        exit 0
      }
      exit 1
    }
  ' "${msg_file}" >/dev/null 2>&1
}

for section in "Why:" "What:" "Impact:"; do
  if ! has_header "${section}"; then
    echo "Missing required section header: ${section}" >&2
    exit 1
  fi
done

if ! section_has_bullet "Why:" "What:"; then
  echo "Section Why: must include at least one bullet line starting with '- '" >&2
  exit 1
fi

if ! section_has_bullet "What:" "Impact:"; then
  echo "Section What: must include at least one bullet line starting with '- '" >&2
  exit 1
fi

if ! section_has_bullet "Impact:" ""; then
  echo "Section Impact: must include at least one bullet line starting with '- '" >&2
  exit 1
fi

exit 0
