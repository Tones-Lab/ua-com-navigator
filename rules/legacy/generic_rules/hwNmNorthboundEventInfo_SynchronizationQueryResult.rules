####################
# Monolith rules file created by Eirteic oid-to-rules v0.95
# manually adjusted to handle two enterprises. FDA
####################
# enterprise oid: 1.3.6.1.4.1.2011.2.15.1.7.1.0
# enterprise oid: 1.3.6.1.4.1.2011.2.15.1.7.7.2.0
####################

my ( %oid, %iid, %val );

$oid{hwNmNorthboundNEName}         = '1.3.6.1.4.1.2011.2.15.1.7.1.1';
$oid{hwNmNorthboundFaultFlag}      = '1.3.6.1.4.1.2011.2.15.1.7.1.10';
$oid{hwNmNorthboundFaultFunction}  = '1.3.6.1.4.1.2011.2.15.1.7.1.11';
$oid{hwNmNorthboundDeviceIP}       = '1.3.6.1.4.1.2011.2.15.1.7.1.12';
$oid{hwNmNorthboundSerialNo}       = '1.3.6.1.4.1.2011.2.15.1.7.1.13';
$oid{hwNmNorthboundProbableRepair} = '1.3.6.1.4.1.2011.2.15.1.7.1.14';
$oid{hwNmNorthboundResourceIDs}    = '1.3.6.1.4.1.2011.2.15.1.7.1.15';
$oid{hwNmNorthboundsAdditionalVB1} = '1.3.6.1.4.1.2011.2.15.1.7.1.16';
$oid{hwNmNorthboundsAdditionalVB2} = '1.3.6.1.4.1.2011.2.15.1.7.1.17';
$oid{hwNmNorthboundsAdditionalVB3} = '1.3.6.1.4.1.2011.2.15.1.7.1.18';
$oid{hwNmNorthboundsAdditionalVB4} = '1.3.6.1.4.1.2011.2.15.1.7.1.19';
$oid{hwNmNorthboundNEType}         = '1.3.6.1.4.1.2011.2.15.1.7.1.2';
$oid{hwNmNorthboundsAdditionalVB5} = '1.3.6.1.4.1.2011.2.15.1.7.1.20';
$oid{hwNmNorthboundsAdditionalVB6} = '1.3.6.1.4.1.2011.2.15.1.7.1.21';
$oid{hwNmNorthboundsAdditionalVB7} = '1.3.6.1.4.1.2011.2.15.1.7.1.22';
$oid{hwNmNorthboundsAdditionalVB8} = '1.3.6.1.4.1.2011.2.15.1.7.1.23';
$oid{hwNmNorthboundEventName}      = '1.3.6.1.4.1.2011.2.15.1.7.1.24';
$oid{hwNmNorthboundReasonID}       = '1.3.6.1.4.1.2011.2.15.1.7.1.25';
$oid{hwNmNorthboundFaultID}        = '1.3.6.1.4.1.2011.2.15.1.7.1.26';
$oid{hwNmNorthboundDeviceType}     = '1.3.6.1.4.1.2011.2.15.1.7.1.27';
$oid{hwNmNorthboundTrailName}      = '1.3.6.1.4.1.2011.2.15.1.7.1.28';
$oid{hwNmNorthboundRootAlarm}      = '1.3.6.1.4.1.2011.2.15.1.7.1.29';
$oid{hwNmNorthboundObjectInstance} = '1.3.6.1.4.1.2011.2.15.1.7.1.3';
$oid{hwNmNorthboundGroupID}        = '1.3.6.1.4.1.2011.2.15.1.7.1.30';
$oid{hwNmNorthboundMaintainStatus} = '1.3.6.1.4.1.2011.2.15.1.7.1.31';
$oid{hwNmNorthboundEventType}      = '1.3.6.1.4.1.2011.2.15.1.7.1.4';
$oid{hwNmNorthboundEventTime}      = '1.3.6.1.4.1.2011.2.15.1.7.1.5';
$oid{hwNmNorthboundProbableCause}  = '1.3.6.1.4.1.2011.2.15.1.7.1.6';
$oid{hwNmNorthboundSeverity}       = '1.3.6.1.4.1.2011.2.15.1.7.1.7';
$oid{hwNmNorthboundEventDetail}    = '1.3.6.1.4.1.2011.2.15.1.7.1.8';
$oid{hwNmNorthboundAdditionalInfo} = '1.3.6.1.4.1.2011.2.15.1.7.1.9';

while ( my ( $k, $v ) = each(%$vars) ) {

    # The first two exact keys should always be there:
    if ( $k eq '1.3.6.1.2.1.1.3.0' ) {
        $val{'sysUpTime'} = $v;
    }
    elsif ( $k eq '1.3.6.1.6.3.1.1.4.1.0' ) {
        $val{'snmpTrapOid'} = $v;
    }
    elsif ( $k =~ /^\Q$oid{hwNmNorthboundAdditionalInfo}\E(\.|$)(.*)/ ) {
        $iid{hwNmNorthboundAdditionalInfo} = $2;
        $val{hwNmNorthboundAdditionalInfo} = $v;
    }
    elsif ( $k =~ /^\Q$oid{hwNmNorthboundDeviceIP}\E(\.|$)(.*)/ ) {
        $iid{hwNmNorthboundDeviceIP} = $2;
        $val{hwNmNorthboundDeviceIP} = $v;
    }
    elsif ( $k =~ /^\Q$oid{hwNmNorthboundDeviceType}\E(\.|$)(.*)/ ) {
        $iid{hwNmNorthboundDeviceType} = $2;
        $val{hwNmNorthboundDeviceType} = $v;
    }
    elsif ( $k =~ /^\Q$oid{hwNmNorthboundEventDetail}\E(\.|$)(.*)/ ) {
        $iid{hwNmNorthboundEventDetail} = $2;
        $val{hwNmNorthboundEventDetail} = $v;
    }
    elsif ( $k =~ /^\Q$oid{hwNmNorthboundEventName}\E(\.|$)(.*)/ ) {
        $iid{hwNmNorthboundEventName} = $2;
        $val{hwNmNorthboundEventName} = $v;
    }
    elsif ( $k =~ /^\Q$oid{hwNmNorthboundEventTime}\E(\.|$)(.*)/ ) {
        $iid{hwNmNorthboundEventTime} = $2;
        $val{hwNmNorthboundEventTime} = $v;
    }
    elsif ( $k =~ /^\Q$oid{hwNmNorthboundEventType}\E(\.|$)(.*)/ ) {
        $iid{hwNmNorthboundEventType} = $2;
        $val{hwNmNorthboundEventType} = $v;
    }
    elsif ( $k =~ /^\Q$oid{hwNmNorthboundFaultFlag}\E(\.|$)(.*)/ ) {
        $iid{hwNmNorthboundFaultFlag} = $2;
        $val{hwNmNorthboundFaultFlag} = $v;
    }
    elsif ( $k =~ /^\Q$oid{hwNmNorthboundFaultFunction}\E(\.|$)(.*)/ ) {
        $iid{hwNmNorthboundFaultFunction} = $2;
        $val{hwNmNorthboundFaultFunction} = $v;
    }
    elsif ( $k =~ /^\Q$oid{hwNmNorthboundFaultID}\E(\.|$)(.*)/ ) {
        $iid{hwNmNorthboundFaultID} = $2;
        $val{hwNmNorthboundFaultID} = $v;
    }
    elsif ( $k =~ /^\Q$oid{hwNmNorthboundGroupID}\E(\.|$)(.*)/ ) {
        $iid{hwNmNorthboundGroupID} = $2;
        $val{hwNmNorthboundGroupID} = $v;
    }
    elsif ( $k =~ /^\Q$oid{hwNmNorthboundMaintainStatus}\E(\.|$)(.*)/ ) {
        $iid{hwNmNorthboundMaintainStatus} = $2;
        $val{hwNmNorthboundMaintainStatus} = $v;
    }
    elsif ( $k =~ /^\Q$oid{hwNmNorthboundNEName}\E(\.|$)(.*)/ ) {
        $iid{hwNmNorthboundNEName} = $2;
        $val{hwNmNorthboundNEName} = $v;
    }
    elsif ( $k =~ /^\Q$oid{hwNmNorthboundNEType}\E(\.|$)(.*)/ ) {
        $iid{hwNmNorthboundNEType} = $2;
        $val{hwNmNorthboundNEType} = $v;
    }
    elsif ( $k =~ /^\Q$oid{hwNmNorthboundObjectInstance}\E(\.|$)(.*)/ ) {
        $iid{hwNmNorthboundObjectInstance} = $2;
        $val{hwNmNorthboundObjectInstance} = $v;
    }
    elsif ( $k =~ /^\Q$oid{hwNmNorthboundProbableCause}\E(\.|$)(.*)/ ) {
        $iid{hwNmNorthboundProbableCause} = $2;
        $val{hwNmNorthboundProbableCause} = $v;
    }
    elsif ( $k =~ /^\Q$oid{hwNmNorthboundProbableRepair}\E(\.|$)(.*)/ ) {
        $iid{hwNmNorthboundProbableRepair} = $2;
        $val{hwNmNorthboundProbableRepair} = $v;
    }
    elsif ( $k =~ /^\Q$oid{hwNmNorthboundReasonID}\E(\.|$)(.*)/ ) {
        $iid{hwNmNorthboundReasonID} = $2;
        $val{hwNmNorthboundReasonID} = $v;
    }
    elsif ( $k =~ /^\Q$oid{hwNmNorthboundResourceIDs}\E(\.|$)(.*)/ ) {
        $iid{hwNmNorthboundResourceIDs} = $2;
        $val{hwNmNorthboundResourceIDs} = $v;
    }
    elsif ( $k =~ /^\Q$oid{hwNmNorthboundRootAlarm}\E(\.|$)(.*)/ ) {
        $iid{hwNmNorthboundRootAlarm} = $2;
        $val{hwNmNorthboundRootAlarm} = $v;
    }
    elsif ( $k =~ /^\Q$oid{hwNmNorthboundSerialNo}\E(\.|$)(.*)/ ) {
        $iid{hwNmNorthboundSerialNo} = $2;
        $val{hwNmNorthboundSerialNo} = $v;
    }
    elsif ( $k =~ /^\Q$oid{hwNmNorthboundSeverity}\E(\.|$)(.*)/ ) {
        $iid{hwNmNorthboundSeverity} = $2;
        $val{hwNmNorthboundSeverity} = $v;
    }
    elsif ( $k =~ /^\Q$oid{hwNmNorthboundTrailName}\E(\.|$)(.*)/ ) {
        $iid{hwNmNorthboundTrailName} = $2;
        $val{hwNmNorthboundTrailName} = $v;
    }
    elsif ( $k =~ /^\Q$oid{hwNmNorthboundsAdditionalVB1}\E(\.|$)(.*)/ ) {
        $iid{hwNmNorthboundsAdditionalVB1} = $2;
        $val{hwNmNorthboundsAdditionalVB1} = $v;
    }
    elsif ( $k =~ /^\Q$oid{hwNmNorthboundsAdditionalVB2}\E(\.|$)(.*)/ ) {
        $iid{hwNmNorthboundsAdditionalVB2} = $2;
        $val{hwNmNorthboundsAdditionalVB2} = $v;
    }
    elsif ( $k =~ /^\Q$oid{hwNmNorthboundsAdditionalVB3}\E(\.|$)(.*)/ ) {
        $iid{hwNmNorthboundsAdditionalVB3} = $2;
        $val{hwNmNorthboundsAdditionalVB3} = $v;
    }
    elsif ( $k =~ /^\Q$oid{hwNmNorthboundsAdditionalVB4}\E(\.|$)(.*)/ ) {
        $iid{hwNmNorthboundsAdditionalVB4} = $2;
        $val{hwNmNorthboundsAdditionalVB4} = $v;
    }
    elsif ( $k =~ /^\Q$oid{hwNmNorthboundsAdditionalVB5}\E(\.|$)(.*)/ ) {
        $iid{hwNmNorthboundsAdditionalVB5} = $2;
        $val{hwNmNorthboundsAdditionalVB5} = $v;
    }
    elsif ( $k =~ /^\Q$oid{hwNmNorthboundsAdditionalVB6}\E(\.|$)(.*)/ ) {
        $iid{hwNmNorthboundsAdditionalVB6} = $2;
        $val{hwNmNorthboundsAdditionalVB6} = $v;
    }
    elsif ( $k =~ /^\Q$oid{hwNmNorthboundsAdditionalVB7}\E(\.|$)(.*)/ ) {
        $iid{hwNmNorthboundsAdditionalVB7} = $2;
        $val{hwNmNorthboundsAdditionalVB7} = $v;
    }
    elsif ( $k =~ /^\Q$oid{hwNmNorthboundsAdditionalVB8}\E(\.|$)(.*)/ ) {
        $iid{hwNmNorthboundsAdditionalVB8} = $2;
        $val{hwNmNorthboundsAdditionalVB8} = $v;
    }
}

# This should always be set
$Event->{'Node'} = $node || "$ip";

# These should be set to suitable values per-trap
$Event->{'AlarmType'}     = 14400;    # > 30 = seconds to auto-clear
#$Event->{'Summary'}       = "";
#$Event->{'AlarmGroup'}    = "";
#$Event->{'SubAlarmGroup'} = "";
$Event->{'Severity'}      = 1;    # 0 = minor, 5 = major, 1 = unknown
#$Event->{'AlarmKey'}      = ""; # unique for de-dupe. Include $ip and $summary?

# For each OBJECT, you can use $oid{OBJECT}, $iid{OBJECT}, or $val{OBJECT}

# NOTE: all specifics here have the same allowed OBJECTS (specific ==
# Severity, really). So process in common here, and then just make minor
# changes per-specific

# Observation: hwNmNorthboundEventDetail is of the form
# ID:number,DeviceType:number,descriptive words
# I haven't yet seen hwNmNorthboundEventName

$Event->{Summary} = "$val{hwNmNorthboundEventName}: $val{hwNmNorthboundEventDetail}";

$Event->{Node} = $val{hwNmNorthboundNEName} || $Event->{Node};

# hwNmNorthboundSeverity: map name in varbind to value in monolith
my %sev = (Critical => 5, Major => 4, Minor => 3, Warning => 2, Indeterminate => 1, Cleared => 0);
# Note: check that each of those words is documented somewhere
# I have seen: Critical, Major, Minor, Warning

$Event->{Severity} = $sev{$val{hwNmNorthboundSeverity}};
$Event->{Severity} = 1 unless defined ($Event->{Severity});

# Observation: hwNmNorthboundObjectInstance has been seen as both
# IfName=Ethernet8/11/0 IfIndex=26 Pause Frame Statistics=10 Pause Frame Threshold=500 Time Interval=10
# and things of the form
# Slot=2 Port=5 TTP_TYPE=5 2-N2PQ1-5(Access)-PPI:1
# Spaces and all-sorts can be in the final part

# This may require more thought to become correct

my ($detail1, undef) = split (/,/, $val{hwNmNorthboundEventDetail}, 2);
# detail1 is ID:number
$Event->{SubAlarmGroup} = "$val{hwNmNorthboundObjectInstance}: $detail1";

# Observation: hwNmNorthboundEventType has been seen to be one of:
# Communication, Equipment, Process, Service
$Event->{AlarmGroup} = $val{hwNmNorthboundEventType};

# hwNmNorthboundFaultFlag: map name in varbind to value in monolith
my %fault = (Event => 6, Fault => 2, Recovery => 1);
# I have seen: Fault, Recovery

$Event->{AlarmType} = $fault{$val{hwNmNorthboundFaultFlag}};
$Event->{AlarmType} = 6 unless defined ($Event->{AlarmType});
# For the correlation mechanization, adjust Severity
$Event->{Severity} = 0 if $Event->{AlarmType} == 1;

# set AlarmKey. This need more careful thought for deployment

$Event->{AlarmKey} = "$val{hwNmNorthboundNEName}/$val{hwNmNorthboundObjectInstance}/$val{hwNmNorthboundFaultFlag}/$specific";

if (0) {    # dummy
}
elsif ( $specific == 1 ) {    # hwNmNorthboundEventNotify

    # ============
    # DESCRIPTION:
    #  "Notification for real-time alarm."
    # ============

    # OBJECTS: (all from above)

    # nothing extra here
}
elsif ( $specific == 3 ) {    # hwNmNorthboundEventNotifyCritical

    # ============
    # DESCRIPTION:
    #  "Notification for real-time alarm whose level is Critical."
    # ============

    # OBJECTS: (all from above)

    $Event->{Summary}       = "Critical: $Event->{Summary}";
}
elsif ( $specific == 4 ) {    # hwNmNorthboundEventNotifyMajor

    # ============
    # DESCRIPTION:
    #  "Notification for real-time alarm whose level is Major."
    # ============

    # OBJECTS: (all from above)

    $Event->{Summary}       = "Major: $Event->{Summary}";
}
elsif ( $specific == 5 ) {    # hwNmNorthboundEventNotifyMinor

    # ============
    # DESCRIPTION:
    #  "Notification for real-time alarm whose level is Minor."
    # ============

    # OBJECTS: (all from above)

    $Event->{Summary}       = "Minor: $Event->{Summary}";
}
elsif ( $specific == 6 ) {    # hwNmNorthboundEventNotifyWarning

    # ============
    # DESCRIPTION:
    #  "Notification for real-time alarm whose level is Warning."
    # ============

    # OBJECTS: (all from above)

    $Event->{Summary}       = "Warning: $Event->{Summary}";

}
elsif ( $specific == 7 ) {    # hwNmNorthboundEventNotifyIndefinitely

    # ============
    # DESCRIPTION:
    #  "Notification for real-time alarm whose level is Indefinitely."
    # ============

    # OBJECTS: (all from above)

    $Event->{Summary}       = "Indefinite: $Event->{Summary}";
}
elsif ( $specific == 8 ) {    # hwNmNorthboundEventNotifyUnknownSeverity

    # ============
    # DESCRIPTION:
    #  "Notification for real-time alarm whose level is UnknownSeverity."
    # ============

    # OBJECTS: (all from above)

    $Event->{Summary}       = "Unknown: $Event->{Summary}";

}
elsif ( $specific == 10 ) {    # hwNmNorthboundEventSynchronizationQueryResultNotify

    # ============
    # DESCRIPTION:
    #  "Notification carries the query result of alarm synchronization."
    # ============

    # OBJECTS: (all from above)

# Note: I haven't actually seen one of these traps, so don't know how
# they look.

    # nothing extra here

}
else {    # unknown
    $Event->{'AlarmType'}  = 0;    # never auto-delete
    $Event->{'Summary'}    = "Unknown Trap Specific: $enterprise.$specific";
    $Event->{'AlarmGroup'} = 'UnknownTrap';
    $Event->{'Severity'}   = 1;    # unknown
    $Event->{'AlarmKey'}   = "Unknown Trap from [$ip]: $enterprise.$specific";

    $Event->{'Custom1'}    = $traplog;
}
