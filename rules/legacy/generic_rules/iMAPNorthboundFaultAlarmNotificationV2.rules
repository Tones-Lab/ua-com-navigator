####################
# Monolith rules file created by Eirteic oid-to-rules v0.95
####################
# enterprise oid: 1.3.6.1.4.1.2011.2.15.2.4.3.3.0
####################

my ( %oid, %iid, %val );

$oid{iMAPNorthboundAlarmCSN}                   = '1.3.6.1.4.1.2011.2.15.2.4.3.3.1';
$oid{iMAPNorthboundAlarmType}                  = '1.3.6.1.4.1.2011.2.15.2.4.3.3.10';
$oid{iMAPNorthboundAlarmLevel}                 = '1.3.6.1.4.1.2011.2.15.2.4.3.3.11';
$oid{iMAPNorthboundAlarmRestore}               = '1.3.6.1.4.1.2011.2.15.2.4.3.3.12';
$oid{iMAPNorthboundAlarmConfirm}               = '1.3.6.1.4.1.2011.2.15.2.4.3.3.13';
$oid{iMAPNorthboundAlarmAckTime}               = '1.3.6.1.4.1.2011.2.15.2.4.3.3.14';
$oid{iMAPNorthboundAlarmRestoreTime}           = '1.3.6.1.4.1.2011.2.15.2.4.3.3.15';
$oid{iMAPNorthboundAlarmOperator}              = '1.3.6.1.4.1.2011.2.15.2.4.3.3.16';
$oid{iMAPNorthboundAlarmParas1}                = '1.3.6.1.4.1.2011.2.15.2.4.3.3.17';
$oid{iMAPNorthboundAlarmParas2}                = '1.3.6.1.4.1.2011.2.15.2.4.3.3.18';
$oid{iMAPNorthboundAlarmParas3}                = '1.3.6.1.4.1.2011.2.15.2.4.3.3.19';
$oid{iMAPNorthboundAlarmCategory}              = '1.3.6.1.4.1.2011.2.15.2.4.3.3.2';
$oid{iMAPNorthboundAlarmParas4}                = '1.3.6.1.4.1.2011.2.15.2.4.3.3.20';
$oid{iMAPNorthboundAlarmParas5}                = '1.3.6.1.4.1.2011.2.15.2.4.3.3.21';
$oid{iMAPNorthboundAlarmParas6}                = '1.3.6.1.4.1.2011.2.15.2.4.3.3.22';
$oid{iMAPNorthboundAlarmParas7}                = '1.3.6.1.4.1.2011.2.15.2.4.3.3.23';
$oid{iMAPNorthboundAlarmParas8}                = '1.3.6.1.4.1.2011.2.15.2.4.3.3.24';
$oid{iMAPNorthboundAlarmParas9}                = '1.3.6.1.4.1.2011.2.15.2.4.3.3.25';
$oid{iMAPNorthboundAlarmParas10}               = '1.3.6.1.4.1.2011.2.15.2.4.3.3.26';
$oid{iMAPNorthboundAlarmExtendInfo}            = '1.3.6.1.4.1.2011.2.15.2.4.3.3.27';
$oid{iMAPNorthboundAlarmProbablecause}         = '1.3.6.1.4.1.2011.2.15.2.4.3.3.28';
$oid{iMAPNorthboundAlarmProposedrepairactions} = '1.3.6.1.4.1.2011.2.15.2.4.3.3.29';
$oid{iMAPNorthboundAlarmOccurTime}             = '1.3.6.1.4.1.2011.2.15.2.4.3.3.3';
$oid{iMAPNorthboundAlarmSpecificproblems}      = '1.3.6.1.4.1.2011.2.15.2.4.3.3.30';
$oid{iMAPNorthboundAlarmExtendProductItem1}    = '1.3.6.1.4.1.2011.2.15.2.4.3.3.31';
$oid{iMAPNorthboundAlarmExtendProductItem2}    = '1.3.6.1.4.1.2011.2.15.2.4.3.3.32';
$oid{iMAPNorthboundAlarmExtendProductItem3}    = '1.3.6.1.4.1.2011.2.15.2.4.3.3.33';
$oid{iMAPNorthboundAlarmExtendProductItem4}    = '1.3.6.1.4.1.2011.2.15.2.4.3.3.34';
$oid{iMAPNorthboundAlarmExtendProductItem5}    = '1.3.6.1.4.1.2011.2.15.2.4.3.3.35';
$oid{iMAPNorthboundAlarmExtendProductItem6}    = '1.3.6.1.4.1.2011.2.15.2.4.3.3.36';
$oid{iMAPNorthboundAlarmExtendProductItem7}    = '1.3.6.1.4.1.2011.2.15.2.4.3.3.37';
$oid{iMAPNorthboundAlarmExtendProductItem8}    = '1.3.6.1.4.1.2011.2.15.2.4.3.3.38';
$oid{iMAPNorthboundAlarmExtendProductItem9}    = '1.3.6.1.4.1.2011.2.15.2.4.3.3.39';
$oid{iMAPNorthboundAlarmMOName}                = '1.3.6.1.4.1.2011.2.15.2.4.3.3.4';
$oid{iMAPNorthboundAlarmExtendProductItem10}   = '1.3.6.1.4.1.2011.2.15.2.4.3.3.40';
$oid{iMAPNorthboundAlarmExtendProductItem11}   = '1.3.6.1.4.1.2011.2.15.2.4.3.3.41';
$oid{iMAPNorthboundAlarmExtendProductItem12}   = '1.3.6.1.4.1.2011.2.15.2.4.3.3.42';
$oid{iMAPNorthboundAlarmExtendProductItem13}   = '1.3.6.1.4.1.2011.2.15.2.4.3.3.43';
$oid{iMAPNorthboundAlarmExtendProductItem14}   = '1.3.6.1.4.1.2011.2.15.2.4.3.3.44';
$oid{iMAPNorthboundAlarmExtendProductItem15}   = '1.3.6.1.4.1.2011.2.15.2.4.3.3.45';
$oid{iMAPNorthboundAlarmClearOperator}         = '1.3.6.1.4.1.2011.2.15.2.4.3.3.46';
$oid{iMAPNorthboundAlarmObjectInstanceType}    = '1.3.6.1.4.1.2011.2.15.2.4.3.3.47';
$oid{iMAPNorthboundAlarmClearCategory}         = '1.3.6.1.4.1.2011.2.15.2.4.3.3.48';
$oid{iMAPNorthboundAlarmClearType}             = '1.3.6.1.4.1.2011.2.15.2.4.3.3.49';
$oid{iMAPNorthboundAlarmProductID}             = '1.3.6.1.4.1.2011.2.15.2.4.3.3.5';
$oid{iMAPNorthboundAlarmServiceAffectFlag}     = '1.3.6.1.4.1.2011.2.15.2.4.3.3.50';
$oid{iMAPNorthboundAlarmAdditionalInfo}        = '1.3.6.1.4.1.2011.2.15.2.4.3.3.51';
$oid{iMAPNorthboundAlarmNEType}                = '1.3.6.1.4.1.2011.2.15.2.4.3.3.6';
$oid{iMAPNorthboundAlarmNEDevID}               = '1.3.6.1.4.1.2011.2.15.2.4.3.3.7';
$oid{iMAPNorthboundAlarmDevCsn}                = '1.3.6.1.4.1.2011.2.15.2.4.3.3.8';
$oid{iMAPNorthboundAlarmID}                    = '1.3.6.1.4.1.2011.2.15.2.4.3.3.9';

# In this trap, *all* varbinds have iid=0.
my %dio = reverse %oid;

while ( my ( $k, $v ) = each(%$vars) ) {

    my $k0 = $k;
    $k0 =~ s/\.0$//;
    # The first two exact keys should always be there:
    if ( $k eq '1.3.6.1.2.1.1.3.0' ) {
        $val{'sysUpTime'} = $v;
    }
    elsif ( $k eq '1.3.6.1.6.3.1.1.4.1.0' ) {
        $val{'snmpTrapOid'} = $v;
    }
    elsif ($dio{"$k0"}) {
        $iid{$dio{"$k0"}} = 0;
        $val{$dio{"$k0"}} = $v;
    }
}

# This should always be set
$Event->{'Node'} = $node || "$ip";

# These should be set to suitable values per-trap
$Event->{'AlarmType'}     = 14400;    # > 30 = seconds to auto-clear
#$Event->{'Summary'}       = "";
#$Event->{'AlarmGroup'}    = "";
#$Event->{'SubAlarmGroup'} = "";
$Event->{'Severity'}      = 1;    # 0 = minor, 5 = major, 1 = unknown
#$Event->{'AlarmKey'}      = ""; # unique for de-dupe. Include $ip and $summary?

# For each OBJECT, you can use $oid{OBJECT}, $iid{OBJECT}, or $val{OBJECT}

# Note: specific==1 and specific==3 have exactly the same OBJECTs defined.
# It may be worth handling those in common.

# map iMAPNorthboundAlarmLevel to Monolith severities
# critical(1), major(2), minor(3), warning(4), indeterminate(5), clear(6)
my %sev = ( 1 => 5, 2 => 4, 3 => 3, 4 => 2, 5 => 1, 6 => 0);
my $sev = $sev{$val{iMAPNorthboundAlarmLevel}};
defined($sev) or $sev = 1;

# write the common summary
my $summ = "$val{iMAPNorthboundAlarmMOName}: $val{iMAPNorthboundAlarmProbablecause}; $val{iMAPNorthboundAlarmExtendInfo}";

# Set Node from the trap, if present
$Event->{'Node'} = $val{iMAPNorthboundAlarmMOName} if $val{iMAPNorthboundAlarmMOName};

# Some traps can be sensibly deduplicated. Find parts of the AlarmKey
# to use in these cases
my $keypart;
if ($val{iMAPNorthboundAlarmProbablecause} eq 'Changed working mode of ATAE network ports') {
  $keypart = $val{iMAPNorthboundAlarmExtendInfo};
  $keypart =~ s/.*Network interface=//;
  $keypart = 'port mode ' . $keypart;
} elsif ($val{iMAPNorthboundAlarmProbablecause} eq 'SCCP SSN Paused') {
  $keypart = $val{iMAPNorthboundAlarmExtendInfo};
  $keypart =~ s/.*SSN Name=//;
  $keypart = 'sccp ssn ' . $keypart;
} elsif ($val{iMAPNorthboundAlarmProbablecause} eq 'SCCP DSP Inaccessible') {
  $keypart = $val{iMAPNorthboundAlarmExtendInfo};
  $keypart =~ s/.*DSP Name=//;
  $keypart = 'sccp dsp ' . $keypart;
} elsif ($val{iMAPNorthboundAlarmProbablecause} eq 'M3UA SCTP Path Alarm') {
  $keypart = $val{iMAPNorthboundAlarmExtendInfo};
  $keypart =~ s/.*M3UA Link Name=//;
  $keypart =~ s/,.*//;
  $keypart = 'm3ua sctp ' . $keypart;
} elsif ($val{iMAPNorthboundAlarmProbablecause} eq 'M3UA route is unavailable') {
  $keypart = $val{iMAPNorthboundAlarmExtendInfo};
  $keypart =~ s/.*Route Name=//;
  $keypart =~ s/,.*//;
  $keypart = 'm3ua route ' . $keypart;
} elsif ($val{iMAPNorthboundAlarmProbablecause} eq 'M3UA link fault') {
  $keypart = $val{iMAPNorthboundAlarmExtendInfo};
  $keypart =~ s/.*M3UA Link Name=//;
  $keypart =~ s/,.*//;
  $keypart = 'm3ua link ' . $keypart;
} elsif ($val{iMAPNorthboundAlarmProbablecause} eq 'M3UA destination entity is inaccessible') {
  $keypart = $val{iMAPNorthboundAlarmExtendInfo};
  $keypart =~ s/.*Destination Entity Name=//;
  $keypart =~ s/,.*//;
  $keypart = 'm3ua dest ' . $keypart;
}

if (0) {    # dummy
}
elsif ( $specific == 1 ) {    # iMAPNorthboundFaultAlarmReportNotificationType

    # ============
    # DESCRIPTION:
    #  "  The iMAP system sends real-time alarms to the NMS using this trap.
    #  				If an alarm occurs to an NE or the iMAP, the iMAP sends the alarm
    #  				trap to the NMS."
    # ============

    # OBJECTS: iMAPNorthboundAlarmCSN iMAPNorthboundAlarmCategory iMAPNorthboundAlarmOccurTime iMAPNorthboundAlarmMOName iMAPNorthboundAlarmProductID iMAPNorthboundAlarmNEType iMAPNorthboundAlarmNEDevID iMAPNorthboundAlarmDevCsn iMAPNorthboundAlarmID iMAPNorthboundAlarmType iMAPNorthboundAlarmLevel iMAPNorthboundAlarmRestore iMAPNorthboundAlarmConfirm iMAPNorthboundAlarmAckTime iMAPNorthboundAlarmRestoreTime iMAPNorthboundAlarmOperator iMAPNorthboundAlarmParas1 iMAPNorthboundAlarmParas2 iMAPNorthboundAlarmParas3 iMAPNorthboundAlarmParas4 iMAPNorthboundAlarmParas5 iMAPNorthboundAlarmParas6 iMAPNorthboundAlarmParas7 iMAPNorthboundAlarmParas8 iMAPNorthboundAlarmParas9 iMAPNorthboundAlarmParas10 iMAPNorthboundAlarmExtendInfo iMAPNorthboundAlarmProbablecause iMAPNorthboundAlarmProposedrepairactions iMAPNorthboundAlarmSpecificproblems iMAPNorthboundAlarmExtendProductItem1 iMAPNorthboundAlarmExtendProductItem2 iMAPNorthboundAlarmExtendProductItem3 iMAPNorthboundAlarmExtendProductItem4 iMAPNorthboundAlarmExtendProductItem5 iMAPNorthboundAlarmExtendProductItem6 iMAPNorthboundAlarmExtendProductItem7 iMAPNorthboundAlarmExtendProductItem8 iMAPNorthboundAlarmExtendProductItem9 iMAPNorthboundAlarmExtendProductItem10 iMAPNorthboundAlarmExtendProductItem11 iMAPNorthboundAlarmExtendProductItem12 iMAPNorthboundAlarmExtendProductItem13 iMAPNorthboundAlarmExtendProductItem14 iMAPNorthboundAlarmExtendProductItem15 iMAPNorthboundAlarmClearOperator iMAPNorthboundAlarmAdditionalInfo iMAPNorthboundAlarmClearType iMAPNorthboundAlarmClearCategory iMAPNorthboundAlarmServiceAffectFlag iMAPNorthboundAlarmObjectInstanceType

    #$Event->{'AlarmType'}     = 14400;
    $Event->{'Summary'}       = "$summ";
    $Event->{'AlarmGroup'}    = "iMAPNorthboundFaultAlarmReportNotificationType";
    #$Event->{'SubAlarmGroup'} = "iMAPNorthboundFaultAlarmReportNotificationType";
    $Event->{'Severity'}      = $sev;
    $Event->{'AlarmKey'}      = "$ip: iMAPNbFault ";
    if ($keypart) {
      $Event->{'AlarmKey'} .= "$keypart";
    } else {
      $Event->{'AlarmKey'} .= "$val{iMAPNorthboundAlarmCSN}.";
    }
}
elsif ( $specific == 2 ) {    # iMAPNorthboundFaultAlarmQueryBeginNotificationType

    # ============
    # DESCRIPTION:
    #  "The iMAP notifies the NMS of the start of the query.
    #  				After the NMS receives the active/current alarm query start 
    #  				trap, the query starts.
    #  				
    #  				The trap is triggered by NMS for alarm query."
    # ============

    # OBJECTS: 

    #$Event->{'AlarmType'}     = 14400;
    $Event->{'Summary'}       = "iMAPNorthboundFaultAlarmQueryBeginNotificationType";
    $Event->{'AlarmGroup'}    = "iMAPNorthboundFaultAlarmQueryBeginNotificationType";
    #$Event->{'SubAlarmGroup'} = "iMAPNorthboundFaultAlarmQueryBeginNotificationType";
    $Event->{'Severity'}      = 1;
    $Event->{'AlarmKey'}      = "$ip: iMAPNorthboundFaultAlarmQueryBeginNotificationType alarm.";
}
elsif ( $specific == 3 ) {    # iMAPNorthboundFaultAlarmQueryNotificationType

    # ============
    # DESCRIPTION:
    #  " The iMAP system sends queried alarms to the NMS using this trap."
    # ============

    # OBJECTS: iMAPNorthboundAlarmCSN iMAPNorthboundAlarmCategory iMAPNorthboundAlarmOccurTime iMAPNorthboundAlarmMOName iMAPNorthboundAlarmProductID iMAPNorthboundAlarmNEType iMAPNorthboundAlarmNEDevID iMAPNorthboundAlarmDevCsn iMAPNorthboundAlarmID iMAPNorthboundAlarmType iMAPNorthboundAlarmLevel iMAPNorthboundAlarmRestore iMAPNorthboundAlarmConfirm iMAPNorthboundAlarmAckTime iMAPNorthboundAlarmRestoreTime iMAPNorthboundAlarmOperator iMAPNorthboundAlarmParas1 iMAPNorthboundAlarmParas2 iMAPNorthboundAlarmParas3 iMAPNorthboundAlarmParas4 iMAPNorthboundAlarmParas5 iMAPNorthboundAlarmParas6 iMAPNorthboundAlarmParas7 iMAPNorthboundAlarmParas8 iMAPNorthboundAlarmParas9 iMAPNorthboundAlarmParas10 iMAPNorthboundAlarmExtendInfo iMAPNorthboundAlarmProbablecause iMAPNorthboundAlarmProposedrepairactions iMAPNorthboundAlarmSpecificproblems iMAPNorthboundAlarmExtendProductItem1 iMAPNorthboundAlarmExtendProductItem2 iMAPNorthboundAlarmExtendProductItem3 iMAPNorthboundAlarmExtendProductItem4 iMAPNorthboundAlarmExtendProductItem5 iMAPNorthboundAlarmExtendProductItem6 iMAPNorthboundAlarmExtendProductItem7 iMAPNorthboundAlarmExtendProductItem8 iMAPNorthboundAlarmExtendProductItem9 iMAPNorthboundAlarmExtendProductItem10 iMAPNorthboundAlarmExtendProductItem11 iMAPNorthboundAlarmExtendProductItem12 iMAPNorthboundAlarmExtendProductItem13 iMAPNorthboundAlarmExtendProductItem14 iMAPNorthboundAlarmExtendProductItem15 iMAPNorthboundAlarmClearOperator iMAPNorthboundAlarmAdditionalInfo iMAPNorthboundAlarmServiceAffectFlag iMAPNorthboundAlarmClearType iMAPNorthboundAlarmClearCategory iMAPNorthboundAlarmObjectInstanceType

    #$Event->{'AlarmType'}     = 14400;
    $Event->{'Summary'}       = "iMAPNorthboundFaultAlarmQueryNotificationType";
    $Event->{'AlarmGroup'}    = "iMAPNorthboundFaultAlarmQueryNotificationType";
    #$Event->{'SubAlarmGroup'} = "iMAPNorthboundFaultAlarmQueryNotificationType";
    $Event->{'Severity'}      = 1;
    $Event->{'AlarmKey'}      = "$ip: iMAPNorthboundFaultAlarmQueryNotificationType alarm.";
}
elsif ( $specific == 4 ) {    # iMAPNorthboundFaultAlarmQueryEndNotificationType

    # ============
    # DESCRIPTION:
    #  "  The iMAP notifies the NMS of the stop of the query.
    #  				After the NMS receives the active/current alarm query stop
    #  				trap, it indicates that the query ends.
    #  				
    #  				The NMS triggers the stop of the query, or the query
    #  				ends after the NMS receives the active/current alarms."
    # ============

    # OBJECTS: 

    #$Event->{'AlarmType'}     = 14400;
    $Event->{'Summary'}       = "iMAPNorthboundFaultAlarmQueryEndNotificationType";
    $Event->{'AlarmGroup'}    = "iMAPNorthboundFaultAlarmQueryEndNotificationType";
    #$Event->{'SubAlarmGroup'} = "iMAPNorthboundFaultAlarmQueryEndNotificationType";
    $Event->{'Severity'}      = 1;
    $Event->{'AlarmKey'}      = "$ip: iMAPNorthboundFaultAlarmQueryEndNotificationType alarm.";
}
else {    # unknown
    $Event->{'AlarmType'}  = 0;    # never auto-delete
    $Event->{'Summary'}    = "Unknown Trap Specific: $enterprise.$specific";
    $Event->{'AlarmGroup'} = 'UnknownTrap';
    $Event->{'Severity'}   = 1;    # unknown
    $Event->{'AlarmKey'}   = "Unknown Trap from [$ip]: $enterprise.$specific";

    $Event->{'Custom1'}    = $traplog;
}
