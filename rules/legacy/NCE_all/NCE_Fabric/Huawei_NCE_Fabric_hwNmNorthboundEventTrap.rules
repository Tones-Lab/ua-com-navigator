# ------------------------------------------------------------------------------------------------------------- #
#
#
#
#  █████╗ ██╗   ██╗████████╗ ██████╗       ██████╗ ███████╗██████╗ ██╗      ██████╗ ██╗   ██╗███████╗██████╗ 
#  ██╔══██╗██║   ██║╚══██╔══╝██╔═══██╗      ██╔══██╗██╔════╝██╔══██╗██║     ██╔═══██╗╚██╗ ██╔╝██╔════╝██╔══██╗
#  ███████║██║   ██║   ██║   ██║   ██║█████╗██║  ██║█████╗  ██████╔╝██║     ██║   ██║ ╚████╔╝ █████╗  ██║  ██║
#  ██╔══██║██║   ██║   ██║   ██║   ██║╚════╝██║  ██║██╔══╝  ██╔═══╝ ██║     ██║   ██║  ╚██╔╝  ██╔══╝  ██║  ██║
#  ██║  ██║╚██████╔╝   ██║   ╚██████╔╝      ██████╔╝███████╗██║     ███████╗╚██████╔╝   ██║   ███████╗██████╔╝
#  ╚═╝  ╚═╝ ╚═════╝    ╚═╝    ╚═════╝       ╚═════╝ ╚══════╝╚═╝     ╚══════╝ ╚═════╝    ╚═╝   ╚══════╝╚═════╝ 
#  
#
#
#  Added by         D E P L O Y M E N T
#
#    Changes via the UI get's overwritten on the next deployment.
#
# ------------------------------------------------------------------------------------------------------------- #
#---------------------------------------------------------------------------------------------------------
# Descpription: Here are only hwNmNorthboundEventTrap trap:
# OID:            .1.3.6.1.4.1.2011.2.15.1.7.1
# Name:           hwNmNorthboundEventTrap
# Reference:	  Netcool: Huawei_NCE_hwNmNorthboundEventTrap.rules
#---------------------------------------------------------------------------------------------------------
use Time::Piece; 
my $rulesfile = "Huawei_NCE_Fabric_hwNmNorthboundEventTrap.rules";
$Log->Message('DEBUG', "Executing: " . $rulesfile);
$Event->{SubMethod} = $rulesfile;

# @HelpKey used for customized rules therefore needs to be the same for hwNmNorthboundEventTraps and hwNmNorthboundEventSynchronizationQueryResults	
if ($enterprise eq "1.3.6.1.4.1.2011.2.15.1.7.7.2") {
    $Event->{'HelpKey'}			= "1.3.6.1.4.1.2011.2.15.1.7.1" . "|" . $generic . "|1"; # hardcoded to specific 1 so rules for event & syncEvent are the same
}
#---------------------------------------------------------------------------------------------------------------------------------
# Token Split
#---------------------------------------------------------------------------------------------------------------------------------
#$enterprise - Huawei traps, hwNmNorthboundEventTrap
# OID      .1.3.6.1.4.1.2011.2.15.1.7.1
# case 1:  hwNmNorthboundEventNotify
# case 3:  hwNmNorthboundEventNotifyCritical
# case 4:  hwNmNorthboundEventNotifyMajor
# case 5:  hwNmNorthboundEventNotifyMinor
# case 6:  hwNmNorthboundEventNotifyWarning
# case 7:  hwNmNorthboundEventNotifyIndefinitely
# case 8:  hwNmNorthboundEventNotifyUnknownSeverity

#$enterprise - Huawei synchronized traps, hwNmNorthboundEventSynchronizationQueryResult
# OID      .1.3.6.1.4.1.2011.2.15.1.7.7.2
# case 10: hwNmNorthboundEventSynchronizationQueryResultNotify

if ( ( $enterprise eq "1.3.6.1.4.1.2011.2.15.1.7.1"   && $specific_trap =~ /^(1|3|4|5|6|7|8)$/ ) || 
     ( $enterprise eq "1.3.6.1.4.1.2011.2.15.1.7.7.2" && $specific == 10 ) ) {

	my $hwNmNorthboundNEName = $v1;
	my $hwNmNorthboundNEType = $v2;
	my $hwNmNorthboundObjectInstance = $v3;
	my $hwNmNorthboundEventType = $v4;
	my $hwNmNorthboundEventTime = $v5;
	my $hwNmNorthboundProbableCause = $v6;
	my $hwNmNorthboundSeverity = $v7;
	my $hwNmNorthboundEventDetail = $v8;
	my $hwNmNorthboundAdditionalInfo = $v9;
	my $hwNmNorthboundFaultFlag = $v10;
	my $hwNmNorthboundFaultFunction = $v11;
	my $hwNmNorthboundDeviceIP = $v12;
	my $hwNmNorthboundSerialNo = $v13;
	my $hwNmNorthboundProbableRepair = $v14;
	my $hwNmNorthboundResourceIDs = $v15;
	my $hwNmNorthboundEventName = $v16;
	my $hwNmNorthboundReasonID = $v17;
	my $hwNmNorthboundFaultID = $v18;
	my $hwNmNorthboundDeviceType = $v19;
	my $hwNmNorthboundTrailName = $v20;
	my $hwNmNorthboundRootAlarm = $v21;
	my $hwNmNorthboundGroupID = $v22;
	my $hwNmNorthboundMaintainStatus = $v23;
	my $hwNmNorthboundRootAlarmSerialNo = $v24;
	my $hwNmNorthboundConfirmStatus = $v25;
	my $hwNmNorthboundRestoreStatus = $v26;

    $Event->{'Node'}					= $hwNmNorthboundNEName;
    $Event->{'NodeAlias'}				= $hwNmNorthboundNEName;
    $Event->{'IPAddress'}				= $hwNmNorthboundDeviceIP;
    $Event->{'AlarmCategorization1'}	= "NCE-Fabric";
    $Event->{'AlarmCategorization2'}	= $hwNmNorthboundEventName;
    $Event->{'EventType'}				= $hwNmNorthboundObjectInstance;
    $Event->{'SubNode'}					= $hwNmNorthboundFaultID;
    $Event->{'DeviceType'}				= $hwNmNorthboundNEType;
    $Event->{'Location'}				= "N/A";
    $Event->{AlarmCode} = $hwNmNorthboundFaultID;
    $Event->{'EMSAlarmID'}				= $hwNmNorthboundSerialNo;
    
    LibUtil_SetAdditionalInfo($Event,"EventDetail", $hwNmNorthboundEventDetail);
  
    LibUtil_SetAdditionalInfo($Event,"AdditionalInfo", $hwNmNorthboundAdditionalInfo);

    LibUtil_SetAdditionalInfo($Event,"ProbableCause", $hwNmNorthboundProbableCause);
    $Log->Message('DEBUG', "AdditionalInfo set to: $Event->{'AdditionalInfo'}");
    
    #source=B52-Test-Leaf02-2 location=Physical entity name=100GE1/0/1,Fault cause=The output optical power of the optical module was too low
    if ($hwNmNorthboundObjectInstance =~ /location=.+/) {
    	$hwNmNorthboundObjectInstance =~ /location=(.*)/;
		my $extracted_value = $1;
		$Event->{'Summary'} = $hwNmNorthboundEventName . " (" . $hwNmNorthboundFaultID .") - " . $extracted_value;
	} else {
		$Event->{Summary} = $hwNmNorthboundEventName  . " (" . $hwNmNorthboundFaultID .")";
	}
	
    # Example of Timestamp: hwNmNorthboundEventTime : 2015/11/30 - 21:11:39Z
	# 2019/12/13 - 14:34:19
    if ($hwNmNorthboundEventTime =~ /\d{4}\/\d{2}\/\d{2} - \d{2}:\d{2}:\d{2}/) {
       	$Event->{'NEFirstReported'}	=Time::Piece->strptime($hwNmNorthboundEventTime, "%Y/%m/%d - %H:%M:%SZ")->epoch;
		$Event->{'NELastReported'}=Time::Piece->strptime($hwNmNorthboundEventTime, "%Y/%m/%d - %H:%M:%SZ")->epoch;
	} else {
		$Log->Message('DEBUG', "hwNmNorthboundEventTime Pattern NOT FOUND: [". $hwNmNorthboundEventTime ."]");
	}

	if (exists $huawei_iMaster_nce_lookup_hwNmNorthboundEventTrap_severities{$hwNmNorthboundSeverity}) {
        $Event->{Severity} = $huawei_iMaster_nce_lookup_hwNmNorthboundEventTrap_severities{$hwNmNorthboundSeverity};
    }
	
	if ($hwNmNorthboundFaultFlag eq "Fault"){
		$Event->{'EventCategory'}					= 2;
        $Event->{AlarmCode} = "Alarm " . $Event->{AlarmCode};
	} elsif ($hwNmNorthboundFaultFlag eq "Recovery") {
		$Event->{'EventCategory'}					= 1;
		$Event->{'Severity'} = 0;
        $Event->{AlarmCode} = "Alarm " . $Event->{AlarmCode};
	} elsif ($hwNmNorthboundFaultFlag eq "Event") {
		$Event->{'EventCategory'}					=12; 
		$Event->{'Summary'}							= "Event: " . $Event->{'Summary'};
        $Event->{AlarmCode} = "Event " . $Event->{AlarmCode};
	} else {
		$Event->{'EventCategory'}					=12;
	}
		
		$Event->{'HelpKey'}					= $Event->{'HelpKey'} . " - " . $hwNmNorthboundGroupID . " - " . $hwNmNorthboundFaultID;
}

$Log->Message('DEBUG', $rulesfile . " ...done");